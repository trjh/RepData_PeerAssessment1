---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---
### Analysis of an individual's activity monitoring data 

<!-- note to self: http://rmarkdown.rstudio.com/
    If you are not using RStudio then you simply need to call the
    rmarkdown::render function, for example:

    rmarkdown::render("input.Rmd")

    Note that in the case using the "Knit" button in RStudio the basic
    mechanism is the same (RStudio calls the rmarkdown::render function under
    the hood)

    ...but this requires pandoc:
    > rmarkdown::render("PA1_template.Rmd")
    Error: pandoc version 1.12.3 or higher is required and was not found.

    ...which in turn requires either a lot of Haskell, or RStudio:
    http://r.789695.n4.nabble.com/Apply-rmarkdown-render-outside-the-RStudio-don-t-find-pandoc-td4696190.html
    https://github.com/rstudio/rmarkdown/blob/master/PANDOC.md
-->

## Loading and preprocessing the data

> Show any code that is needed to
> 
> 1. Load the data (i.e. read.csv())
> 
> 1. Process/transform the data (if necessary) into a format suitable for your analysis

The following code will unzip the data file (if neccesary), read it in to
memory, and place the data into a dplyr data frame table.

We may not need it, but for now let's also put the date column into datetime
format with lubridate.

```{r}
library(dplyr, warn.conflicts = FALSE)
library(lubridate)

filename="activity.csv"
if(!file.exists(filename)) {
    unzip("activity.zip")
}
if(!file.exists(filename)) {
    stop("Cannot find ",filename," file")
}

activity <- read.csv("activity.csv")

activity <- tbl_df(activity) %>%
    transmute(steps, date = ymd(date), interval)

summary(activity)
```

&nbsp;  <!-- I need more space here than markdown will give me by default! -->


## What is the mean total number of steps taken per day?

> For this part of the assignment, you can ignore the missing values in the dataset.
>
> 1. Calculate the total number of steps taken per day
> 
> 1. Make a histogram of the total number of steps taken each day
> 
> 1. Calculate and report the mean and median of the total number of steps taken per day
  
Now we'll create a table that sums up the number of steps per day.  dplyr
makes this very easy.

We won't remove the missing values from the dataset at this stage, as it makes
it impossible to distinguish between days when we don't have data, and days
when the subject appears to have stayed completely stationary.

```{r}
dailysummary <- activity %>%
                group_by(date) %>%
                summarize(steps = sum(steps))

head(dailysummary,3)
```


We'll now create a histogram[^hist] of the number of steps taken per day.
This shows us that the number of steps per day generally resembles a bell
curve, with the mean lying just above the 10,000 steps mark -- however, there
are at least a couple of days where it would appear that the subject did not
move at all.  (Though perhaps, charitabily, we can assume that the subject
left their step-measuring device behind for a day.)

```{r}
with(dailysummary, hist(steps,30))
```

Finally, we can see that the mean and median number of steps are nearly identical:

```{r}
meandaily_steps   <- mean(dailysummary$steps, na.rm = TRUE)
meandaily_steps   <- format(meandaily_steps, digits = 7)

mediandaily_steps <- median(dailysummary$steps, na.rm = TRUE)
```

The mean of the total steps per day is `r meandaily_steps`, and the median is
`r mediandaily_steps`.

[^hist]: I tend to prefer ggplot2 graphs, but the base plot system seems to
have the cleanest histograms, at least by default.

&nbsp;  <!-- I need more space here than markdown will give me by default! -->


## What is the average daily activity pattern?

> 1. Make a time series plot (i.e. type = "l") of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)
> 1. Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?

There may be a way to do this directly via qplot() or ggplot() arguments, but
let's keep things simple and make ourselves another summary table.  With this
table, creating the time series plot is easy.

```{r}
intervalsummary <- activity %>%
                    group_by(interval) %>%
                    summarize(meansteps = mean(steps, na.rm = TRUE), medsteps = median(steps, na.rm = TRUE))
# with(intervalsummary, plot(interval, steps, type = "l"))

library(ggplot2)
qplot(interval, meansteps, geom = "line", data = intervalsummary)
```

The following code shows us that the individual averages the most steps during the interval corresponding to 8:35 in the morning.

```{r}
filter(intervalsummary, meansteps == max(meansteps))
```

&nbsp;  <!-- I need more space here than markdown will give me by default! -->


## Imputing missing values
> Note that there are a number of days/intervals where there are missing values (coded as NA). The presence of missing days may introduce bias into some calculations or summaries of the data.
>
> 1. Calculate and report the total number of missing values in the dataset (i.e. the total number of rows with NAs)
> 1. Devise a strategy for filling in all of the missing values in the dataset. The strategy does not need to be sophisticated. For example, you could use the mean/median for that day, or the mean for that 5-minute interval, etc.
> 1. Create a new dataset that is equal to the original dataset but with the missing data filled in.
> 1. Make a histogram of the total number of steps taken each day and Calculate and report the mean and median total number of steps taken per day. Do these values differ from the estimates from the first part of the assignment? What is the impact of imputing missing data on the estimates of the total daily number of steps?

```{r}
missing <- nrow(filter(activity, is.na(steps)))
missingpercentage <- format((missing / nrow(activity)) * 100, digits = 4)
cat(paste("There are", missing, "missing rows in the table, representing",
          missingpercentage, "percent of the total rows"))
```

The easiest & most reasonable strategy, to my mind, is to fill any missing
interval with the mean for the appropriate 5-minute interval.  However, it
takes a bit of the fun out of divising if that strategy is drectly in the
question.  A second-order approximation would combine the two suggestions,
using any data available for a day with missing values to help compute an
appropriate in-fill value.

Unfortunately, as the following code snippet shows, the missing values in this
data set span entire dates at a time -- there are no dates with only partial
missing values.

```{r}
activity %>%
    transform(na = is.na(steps)) %>%
    group_by(date) %>%
    summarize(nas = sum(na)) %>%
    arrange(nas) %>%
    tail(9)
```

So we don't have any indication from the date itself as to the level of
activity.  Any intelligent attempt to fill in the values for the day would
have to base variance from patterns based on day of the week, day of the
month, surrounding days activity, etc.

As I haven't got weeks to spend on this assignment, I'll just fill in any NA
value for a given interval with the median number of steps for that interval
as measured across the entire data set.  Still, let's make sure that adding up
all the median-interval-step-values doesn't result in a daily step total that
varies from the average step value for a day.

```{r}
intervalsmean_sum = sum(intervalsummary$meansteps)
intervalsmedian_sum = sum(intervalsummary$medsteps)
mediandaily_steps - intervalsmedian_sum
mediandaily_steps - intervalsmean_sum
```

Clearly I don't want to use the median value of the steps across all values of
interval X.  I'll use the average value, but also `round()` the average, as a
fractional number of steps doesn't make much sense.  So here we create a short
function to replace any NA values -- it requires the steps value and the
interval value as input.  We then use `mapply()` to pass the steps and
interval values to this function in order to build ourselves a new steps
column that imputes missing values.  Finally, we use data.frame and tbl_df to
re-assemble an activity table in dplyr data frame format.

```{r}
complete_steps <- function(steps, interval) {
    newsteps <- steps
    if (is.na(steps)) {
        newsteps <- round(intervalsummary[intervalsummary$interval==interval,]$meansteps)    
    }
    newsteps
}

newstepscol <- with(activity, mapply(complete_steps, steps, interval))
newactivity <- tbl_df(data.frame(steps = newstepscol, date = activity$date, interval = activity$interval))
head(newactivity)
```

Now we make a histogram, and compute the mean and median of the new set.  I
don't expect the mean & median to change, though perhaps the histogram will
change slightly, increasing the peak at the middle.

We'll put the new and old mean & median values into a table.  Because it's no
fun to learn stuff on the slides and not use ALL of it!

```{r showtable,results="asis"}
ndailysummary <- newactivity %>%
		 group_by(date) %>%
		 summarize(steps = sum(steps))

with(ndailysummary, hist(steps,30))

nmeandaily_steps   <- mean(ndailysummary$steps, na.rm = TRUE)
nmediandaily_steps <- median(ndailysummary$steps, na.rm = TRUE)

results <- c(meandaily_steps, mediandaily_steps,
	     nmeandaily_steps, nmediandaily_steps)
dim(results) <- c(2,2)
rownames(results) <- c("orig data", "infilled data")
colnames(results) <- c("mean", "median")
library(xtable)
print(xtable(results, digits=7, center=c("r","r")), type = "html")
```

*** Do these values differ from the estimates from the first part of the assignment?

WHAT IS THE IMPACT OF IMPUTING MISSING DATA ON THE ESTIMATES OF THE TOTAL
DAILY NUMBER OF STEPS?

One more set of graphs to show us the two histograms, side-by-side

```{r fig.width=10}
par(mfrow = c(1,2), yaxp = c(0,20,5))
with( dailysummary, hist(steps,30, ylim = c(0,20)))
with(ndailysummary, hist(steps,30, ylim = c(0,20)))
```

> 1. Make a histogram of the total number of steps taken each day and Calculate and report the mean and median total number of steps taken per day. Do these values differ from the estimates from the first part of the assignment? What is the impact of imputing missing data on the estimates of the total daily number of steps?

&nbsp;  <!-- I need more space here than markdown will give me by default! -->


## Are there differences in activity patterns between weekdays and weekends?

## Notes
So now I'm going to give up and go back to the average, though the next section makes me think perhaps I should be basing it on the average for the day of the week.  Let's do a quick graph to tell us what that looks like

dt <- qplot(as.Date(date), steps, geom = "line", data = dailysummary)

dt + scale_x_date(breaks = "1 week")
